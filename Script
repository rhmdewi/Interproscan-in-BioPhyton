import os
import subprocess
from glob import glob

# === Konfigurasi ===
interproscan_path = "/mnt/c/Users/HP/interproscan-5.73-104.0/interproscan.sh"
input_folder = "/mnt/c/Pisang/fixed"
log_folder = os.path.join(input_folder, "logs")

# Buat folder logs kalau belum ada
os.makedirs(log_folder, exist_ok=True)

# Cari semua file .fasta di folder input
fasta_files = glob(os.path.join(input_folder, "*.fasta"))

print(f"[INFO] Ditemukan {len(fasta_files)} file FASTA untuk dianalisis.")

# Loop tiap file dan jalankan InterProScan
for fasta_path in fasta_files:
    basename = os.path.basename(fasta_path)
    name_only = os.path.splitext(basename)[0]

    output_tsv = os.path.join(input_folder, f"{name_only}_interpro.tsv")
    log_path = os.path.join(log_folder, f"{name_only}_interpro.log")

    # Lewati kalau output sudah ada
    if os.path.exists(output_tsv):
        print(f"[SKIP] Lewati {basename} (sudah dianalisis)")
        continue

    print(f"[RUN ] Menjalankan InterProScan untuk: {basename}")

    command = [
        interproscan_path,
        "-i", fasta_path,
        "-f", "tsv",
        "-o", output_tsv,
        "--disable-precalc",
        "-appl", "Pfam",
        "--cpu", "1"
    ]

    with open(log_path, "w") as log_file:
        result = subprocess.run(command, stdout=log_file, stderr=subprocess.STDOUT)

    if result.returncode == 0:
        print(f"[DONE] Selesai: {name_only}_interpro.tsv")
    else:
        print(f"[FAIL] Gagal: {name_only} â€” lihat log: {log_path}")

print("[INFO] Semua file selesai diproses.")
